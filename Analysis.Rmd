---
title: "All-NBA team Analysis"
output: html_document
---

```{r, echo=FALSE, message=FALSE}
suppressPackageStartupMessages({
  # Data wrangling + plotting
library(tidyverse)
library(data.table)
library(caret)
library(RColorBrewer)
library(ggplot2)
  
  # Multinomial regression
library(nnet)
  # Utilities
library(dplyr)
library(reshape2)
library(knitr)
library(kableExtra)
set.seed(400)
})
```


##DATA CLEANING/FORMATTING
```{r}

# Load 2018 Dataset
df_18 <- read_csv("all_nba_2018.csv",show_col_types = FALSE)

#Select Numeric Performance Stats (should be all of them)
df_numeric18 <- df_18 %>% select(minutes_pg,
  fga,
  fg3a,
  fta,
  pts_per_g,
  trb_per_g,
  ast_per_g,
  stl_per_g,
  blk_per_g,
  fg_pct,
  fg3_pct,
  ft_pct
)


# Load 2022 dataset
df <- read_csv("all_nba_2022.csv",show_col_types = FALSE)

#Select numeric variables
df_numeric <- df %>% select(minutes_pg,
  fga,
  fg3a,
  fta,
  pts_per_g,
  trb_per_g,
  ast_per_g,
  stl_per_g,
  blk_per_g,
  fg_pct,
  fg3_pct,
  ft_pct
)
# Update Plot Labels
var_labels <- c(
  minutes_pg = "Minutes per Game",
  fga        = "Field Goal Attempts",
  fg3a       = "3-Point Attempts",
  fta        = "Free Throw Attempts",
  pts_per_g  = "Points per Game",
  trb_per_g  = "Total Rebounds per Game",
  ast_per_g  = "Assists per Game",
  stl_per_g  = "Steals per Game",
  blk_per_g  = "Blocks per Game",
  fg_pct     = "Field Goal %", 
  fg3_pct    = "3-Point %", 
  ft_pct     = "Free Throw %", 
  games      = "Games Played"
)
```

## Creating Standard Correlations
```{r}

# Compute correlation matrix (2022) using pairwise
corr_mat <- cor(df_numeric, use = "pairwise.complete.obs")

# Convert to long format for ggplot heatmap
corr_df <- reshape2::melt(corr_mat)

# Repeat for 2018 season
corr_mat18 <- cor(df_numeric18, use = "pairwise.complete.obs")

corr_df18 <- reshape2::melt(corr_mat18)
```


#3 Plotting Correlations
```{r}
set.seed(400)

# Heatmap for 2022
corr1 <- ggplot(corr_df, aes(Var1, Var2, fill = value)) +
  geom_tile() +
  geom_text(aes(label = sprintf("%.2f", value)), size = 2) + 
  scale_fill_gradient2(low = "#d73027", mid = "#fee08b", high = "#1a9850",
                        midpoint = 0, limits = c(-1, 1)) +
  scale_x_discrete(labels = var_labels) +  
  scale_y_discrete(labels = var_labels) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
    axis.title = element_blank(),
    panel.grid = element_blank()
  ) +
  coord_fixed() +
  labs(title = "2022 NBA Heatmap")

saveRDS(corr1, "corr1.rds")

# Heatmap for 2018
corr18 <- ggplot(corr_df18, aes(Var1, Var2, fill = value)) +
  geom_tile() +
  geom_text(aes(label = sprintf("%.2f", value)), size = 2) +
  scale_fill_gradient2(low = "#d73027", mid = "#fee08b", high = "#1a9850",
                       midpoint = 0, limits = c(-1, 1)) +
  scale_x_discrete(labels = var_labels) +  
  scale_y_discrete(labels = var_labels) +
  theme_minimal(base_size = 12) +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1, vjust = 1),
    axis.title = element_blank(),
    panel.grid = element_blank()
  ) +
  coord_fixed() + 
  labs(title = "2018 NBA Heatmap")
print(corr1)
print(corr18)

saveRDS(corr18, "corr18.rds")
```

```{r}
##Replication of Study

##Confusion and Correlation Matrices using Bootstrapping

set.seed(400)


#Reload dataset for modeling
df <- read.csv("all_nba_2022.csv")
df$all_nba_team <- as.factor(df$all_nba_team)


B <- 1000

conf_matrices <- list() #Store each bootstrap confusion matrix

for (i in 1:B) {
  
# Resampling rows with replacement until all classes appear, ie: Team 1,2 and 3
  repeat {
    bootstrap_indices <- sample(1:nrow(df), replace = TRUE)
    bootstrap_sample <- df[bootstrap_indices, ]
    
  
    if (all(levels(df$all_nba_team) %in% bootstrap_sample$all_nba_team)) break
  }
  
  
  #Fit multinomial logistic model to create confusion matrix of All-NBA team placement
  
  model <- multinom(all_nba_team ~ games + minutes_pg + fga + fg3a + fta + 
                      pts_per_g + trb_per_g + ast_per_g + stl_per_g + blk_per_g + 
                      fg_pct + fg3_pct + ft_pct, 
                    data = bootstrap_sample, trace = FALSE)
  # Predict on the full dataset
  
  preds <- predict(model, newdata = df)
  
  # Confusion matrix for this bootstrap run
  cm <- confusionMatrix(preds, df$all_nba_team)
  
  conf_matrices[[i]] <- cm$table
}

#Average the confusion matrices across all bootstrap samples 5
avg_cm <- Reduce("+", conf_matrices) / B


print(avg_cm)
```


```{r}
## Correlation Bootstrapping

num_vars <- df %>% 
  select(games, minutes_pg, fga, fg3a, fta,
         pts_per_g, trb_per_g, ast_per_g, stl_per_g, blk_per_g,
         fg_pct, fg3_pct, ft_pct)

B <- 1000
corr_list <- vector("list", B)

for (i in 1:B) {

  #Sample rows with replacement (bootstrap)
  bootstrap_indices <- sample(1:nrow(num_vars), replace = TRUE)
  boot_sample <- num_vars[bootstrap_indices, ]

#Compute correlation matrix for this sample
  corr_list[[i]] <- cor(boot_sample, use = "pairwise.complete.obs")
}

#Average Correlation matricies across all bootstrap iterations
avg_corr <- Reduce("+", corr_list) / B
avg_corr

corr_melt <- reshape2::melt(avg_corr)


# Plot bootstrapped average correlation matrix
ggplot(corr_melt, aes(Var1, Var2, fill = value)) +
  geom_tile(color = "white") +
  geom_text(aes(label = sprintf("%.2f", value)), size = 3) +
  scale_fill_gradient2(low = "#d73027", mid = "#fee08b", high = "#1a9850",
    midpoint = 0, limits = c(-1, 1)
  ) +
  scale_x_discrete(labels = var_labels) + 
  scale_y_discrete(labels = var_labels) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1),
    axis.title.x = element_blank(),
    axis.title.y = element_blank()
  ) +
  labs(title = "Bootstrapped Average Correlation Matrix", fill = "Corr")
```

```{r}
library(tibble)

pace_2018  <- 97.3
pace_2022  <- 97.0

tov_2018   <- 13.3
tov_2022   <- 12.8

orb_2018   <- 22.4
orb_2022   <- 23.1

players_2018 <- 494
players_2022 <- 15

league_compare <- tibble(
  season = c(2018, 2022),
  pace = c(pace_2018, pace_2022),
  tov_pct = c(tov_2018, tov_2022),
  orb_pct = c(orb_2018, orb_2022),
  num_players = c(players_2018, players_2022)
)

league_compare


saveRDS(league_compare, "league_compare") 
```

